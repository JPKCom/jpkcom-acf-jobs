name: Build WordPress Plugin ZIP, Generate Plugin Manifest & Deploy

on:
  release:
    types: [published]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup variables
      - name: Setup variables
        id: vars
        run: |
          echo "PLUGIN_SLUG=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_ENV
          TAG_NAME=${GITHUB_REF##*/}
          TAG_NAME=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "ZIP_FILE=$(basename $GITHUB_REPOSITORY).zip" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF##*/}/$(basename $GITHUB_REPOSITORY).zip" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 4Ô∏è‚É£ Install Pandoc
      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      # 5Ô∏è‚É£ Extract metadata and sections from README
      - name: Parse README and generate HTML
        id: readme
        run: |
          mkdir -p gh-pages-html gh-pages-json

          # Extract plugin metadata from README.md (Key: Value)
          declare -A META
          while IFS=":" read -r key value; do
            key=$(echo "$key" | sed 's/^\*\*//;s/\*\*$//;s/ //g')
            value=$(echo "$value" | sed 's/^ *//;s/  *$//')
            [ -n "$key" ] && META[$key]="$value"
          done < <(grep -E '^\*\*[A-Za-z ]+:\*\*' README.md)

          # Save JSON metadata for later
          echo "${META[@]}" > meta.txt
          jq -n '$ARGS.named' --args "${!META[@]}" "${META[@]}" > gh-pages-json/readme_meta.json

          # Convert README.md to full standalone HTML (with <head>, <body>)
          pandoc README.md -f markdown -t html5 \
            --metadata title="${META[PluginName]:-${{ env.PLUGIN_SLUG }}}" \
            -s -o gh-pages-html/index.html \
            --css=https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css \
            --metadata pagetitle="${META[PluginName]:-${{ env.PLUGIN_SLUG }}}"

          # Generate individual sections (with fallback if missing)
          for SECTION in Description Installation Changelog FAQ; do
            CONTENT=$(awk "/^## $SECTION/{flag=1;next}/^## /{flag=0}flag" README.md)
            if [ ! -z "$CONTENT" ]; then
              echo "$CONTENT" | pandoc -f markdown -t html -o gh-pages-json/${SECTION,,}.html
            else
              echo "" > gh-pages-json/${SECTION,,}.html
            fi
          done

          # Extract contributors and tags into environment vars
          CONTRIBUTORS=$(grep -m1 '^\*\*Contributors:\*\*' README.md | sed 's/\*\*Contributors:\*\* //' | tr ',' '\n' | awk '{$1=$1};1')
          TAGS=$(grep -m1 '^\*\*Tags:\*\*' README.md | sed 's/\*\*Tags:\*\* //' | tr ',' '\n' | awk '{$1=$1};1')

          echo "CONTRIBUTORS=$(echo $CONTRIBUTORS | jq -R -s -c 'split(\" \") | map(select(. != \"\"))')" >> $GITHUB_ENV
          echo "TAGS=$(echo $TAGS | jq -R -s -c 'split(\" \") | map(select(. != \"\"))')" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Create plugin ZIP
      - name: Create plugin ZIP
        run: |
          zip -r "${{ env.ZIP_FILE }}" . -x '*.git*' -x '*.github*' -x '*.DS_Store*'

      # 7Ô∏è‚É£ Upload ZIP to GitHub release
      - name: Upload ZIP to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8Ô∏è‚É£ Generate JSON manifest dynamically
      - name: Generate plugin JSON manifest
        shell: python
        run: |
          import os, json

          def load_section_html(name):
              path = f"gh-pages-json/{name}.html"
              return open(path, encoding="utf-8").read() if os.path.exists(path) else ""

          meta = {}
          meta_path = "gh-pages-json/readme_meta.json"
          if os.path.exists(meta_path):
              with open(meta_path, encoding="utf-8") as f:
                  meta = json.load(f)

          # ---- Safe JSON loading helper ----
          def safe_json_env(key, fallback):
              val = os.environ.get(key, "").strip()
              if not val:
                  return fallback
              try:
                  return json.loads(val)
              except Exception:
                  return fallback

          # Parse contributors safely
          contributors_raw = safe_json_env("CONTRIBUTORS", ["JPKCom"])
          contributors = {}
          for username in contributors_raw:
              username = username.strip()
              if username:
                  contributors[username] = {
                      "profile": f"https://profiles.wordpress.org/{username}",
                      "avatar": f"https://wordpress.org/grav-redirect.php?user={username}&s=36"
                  }

          # Parse tags safely
          tags = safe_json_env("TAGS", ["Plugin","WordPress"])

          plugin = {
              "name": meta.get("PluginName", ""),
              "slug": os.environ.get("PLUGIN_SLUG"),
              "version": meta.get("Version", os.environ.get("TAG_NAME")),
              "download_url": os.environ.get("DOWNLOAD_URL"),
              "requires": meta.get("Requiresatleast", "6.8"),
              "tested": meta.get("Testedupto", "6.9"),
              "requires_php": meta.get("RequiresPHP", "8.3"),
              "author": meta.get("Author", ""),
              "author_profile": meta.get("AuthorURI", ""),
              "contributors": contributors,
              "tags": [t.strip() for t in tags],
              "license": meta.get("License", "GPL-2.0+"),
              "license_uri": meta.get("LicenseURI", "http://www.gnu.org/licenses/gpl-2.0.txt"),
              "text_domain": meta.get("TextDomain", ""),
              "domain_path": meta.get("DomainPath", "/languages"),
              "network": meta.get("Network", "true").lower() == "true",
              "requires_plugins": [p.strip() for p in meta.get("RequiresPlugins", "").split(",") if p.strip()],
              "homepage": meta.get("PluginURI", f"https://github.com/JPKCom/{os.environ.get('PLUGIN_SLUG')}"),
              "last_updated": os.environ.get("DATE"),
              "sections": {
                  "description": load_section_html("description"),
                  "installation": load_section_html("installation"),
                  "changelog": load_section_html("changelog"),
                  "faq": load_section_html("faq"),
              },
              "readme_html": open("gh-pages-html/index.html", encoding="utf-8").read() if os.path.exists("gh-pages-html/index.html") else "",
              "banners": {
                  "low": f"https://{os.environ.get('GITHUB_REPOSITORY').split('/')[0].lower()}.github.io/{os.environ.get('PLUGIN_SLUG')}/assets/banner-772x250.avif",
                  "high": f"https://{os.environ.get('GITHUB_REPOSITORY').split('/')[0].lower()}.github.io/{os.environ.get('PLUGIN_SLUG')}/assets/banner-1544x500.avif"
              }
          }

          os.makedirs("gh-pages-json", exist_ok=True)
          with open(f"gh-pages-json/plugin_{os.environ.get('PLUGIN_SLUG')}.json", "w", encoding="utf-8") as f:
              json.dump(plugin, f, indent=2, ensure_ascii=False)

      # 9Ô∏è‚É£ Prepare for deployment
      - name: Prepare gh-pages deployment
        run: |
          mkdir -p gh-pages-deploy
          cp -r gh-pages-json/* gh-pages-deploy/
          cp -r gh-pages-html/* gh-pages-deploy/
          if [ -d "assets" ]; then
            cp -r assets gh-pages-deploy/
          fi

      # üîü Deploy to GitHub Pages
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages-deploy
          publish_branch: gh-pages
          keep_files: false
